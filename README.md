# saphnet-nginx
An Nginx configuration &amp; Docker image to be used within the Sapphic Homelab/Home Server 

Note that this is designed for use as a reverse proxy for publicly (or internally) accessible websites, using port 80 for HTTP and 443 for HTTPS, and works best with [Let's Encrypt](https://letsencrypt.org/). More importantly, this is oriented towards an HTTPS-first approach, with HTTP locations only serving as redirects to HTTPS locations.

Much of this setup was copied from [Nginx Proxy Manager](https://nginxproxymanager.com/), and was also possible, thanks to this guide written by Med Marrouchi: [Setup SSL with Certbot + Nginx in a Dockerized App](https://dev.to/marrouchi/the-challenge-about-ssl-in-docker-containers-no-one-talks-about-32gh)

To run this container, run this command:
```bash
docker run -p 80:80 -p 443:443 \
-v EXAMPLE-DIR/proxies.conf:/etc/nginx/proxies.conf \
ghcr.io/anarchobooleanism/saphnet-nginx:latest
```

For an example on using this with Docker Compose, check out this [example configuration](compose-example/compose.yaml), or this [Certbot-oriented example](compose-example/with-certbot.yaml).

## Note on proxies.conf
saphnet-nginx provides most of the Nginx-related configuration files that are needed to run Nginx, but you still need to define all of the endpoints that it will serve, and how they are handled. This is defined in `proxies.conf`, which should be located (and, therefore, mounted) at `/etc/nginx/proxies.conf`.

The first chunk of this file should look like this:
```nginx
map $scheme $hsts_header {
  https   "max-age=63072000; preload";
}

server { # Always redirect to HTTPS
  listen 80;
  listen [::]:80;
  server_name _;
  return 301 https://$host$request_uri;
}
```
This sets up HSTS for Nginx; this also configures the HTTP endpoint for all locations to simply serve as a redirect host to an equivalent HTTPS location.

For each endpoint/domain that you want to serve with Nginx, you should add this chunk to `proxies.conf`:
```nginx
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  set $forward_scheme http; # Set this to http or https, depending on what the proxied service uses 
  set $server         "ex.am.p.le";   # Set this to the IP address or hostname of the service you want to proxy
  set $port           8080; # Set this to the port of the service you want to proxy
  server_name example.int.saphnet.xyz; # Set this to the domain that you want to serve
  http2 on;
  include conf.d/ssl.conf;
  include conf.d/block-exploits.conf;
  add_header Strict-Transport-Security $hsts_header always;
  ssl_certificate         /etc/letsencrypt/live/EXAMPLE.MAIN.DOMAIN/fullchain.pem; # This assumes the same certificate is used for all domains 
  ssl_certificate_key     /etc/letsencrypt/live/EXAMPLE.MAIN.DOMAIN/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/EXAMPLE.MAIN.DOMAIN/chain.pem;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $http_connection;
  proxy_http_version 1.1;
  location / {
    # HSTS (ngx_http_headers_module is required) (63072000 seconds = 2 years)
    add_header Strict-Transport-Security $hsts_header always;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_http_version 1.1;
    # Proxy!
    include conf.d/proxy.conf;
  }
}
```
This sets all of the information needed to serve a specific endpoint (`example.int.saphnet.xyz`, in this case). First of all, you will need to consider the upstream server that you will connect to for this domain: `$forward_scheme` determines whether to connect via HTTP or HTTPS, `$server` determines the IP address or hostname that is connected to (this can easily be the name of another Docker container, if it exists in the same Docker network as our Nginx container), and `$port` determines the port that is connected to. As well, you will need to consider the outward-facing domain/endpoint that this chunk of configuration is for, which is set in `server_name`. Finally, you will need to consider the Let's Encrypt certificate that is used for this domain: make sure that the certificate is generated by Certbot first before running Nginx, under the `live/<DOMAIN>` subdirectory, and that all Let's Encrypt certificate data is mounted to `/etc/letsencrypt`.